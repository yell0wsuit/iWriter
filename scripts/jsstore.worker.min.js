/*! For license information please see jsstore.worker.min.js.LICENSE.txt */
var JsStoreWorker;(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{QueryManager:()=>rt});var n,r,o,u,i,a,s,c,l=function(e){return Promise.resolve(e)},f=function(e){return new Promise(e)},h="not_array",p="no_value_supplied",y="column_not_exist",d="no_index_found",v="null_value",m="wrong_data_type",b="table_not_exist",g="not_object",_="Db_blocked",w="indexeddb_not_supported",x="null_value_in_where",k="invalid_join_query",T="import_scripts_failed",S="method_not_exist",E="invalid_middleware";(function(e){e.Registered="registerd",e.Failed="failed",e.NotStarted="not_started"})(n||(n={})),function(e){e.String="string",e.Object="object",e.Array="array",e.Number="number",e.Boolean="boolean",e.Null="null",e.DateTime="date_time"}(r||(r={})),function(e){e.InitDb="init_db",e.Get="get",e.Set="set",e.Select="select",e.Insert="insert",e.Update="update",e.Remove="remove",e.OpenDb="open_db",e.Clear="clear",e.DropDb="drop_db",e.Count="count",e.ChangeLogStatus="change_log_status",e.Terminate="terminate",e.Transaction="transaction",e.CloseDb="close_db",e.Union="union",e.Intersect="intersect",e.ImportScripts="import_scripts",e.Middleware="middleware"}(o||(o={})),function(e){e.RequestQueueEmpty="requestQueueEmpty",e.RequestQueueFilled="requestQueueFilled",e.Upgrade="upgrade",e.Create="create",e.Open="open"}(u||(u={})),function(e){e.Where="where",e.Like="like",e.Regex="regex",e.In="in",e.Equal="=",e.Between="-",e.GreaterThan=">",e.LessThan="<",e.GreaterThanEqualTo=">=",e.LessThanEqualTo="<=",e.NotEqualTo="!=",e.Aggregate="aggregate",e.Max="max",e.Min="min",e.Avg="avg",e.Count="count",e.Sum="sum",e.List="list",e.Or="or",e.Skip="skip",e.Limit="limit",e.And="and",e.IgnoreCase="ignoreCase",e.Then="then"}(i||(i={})),function(e){e.ReadOnly="readonly",e.ReadWrite="readwrite"}(a||(a={})),function(e){e.First="f",e.Last="l",e.Any="a"}(s||(s={})),function(e){e.Connected="connected",e.Closed="closed",e.NotStarted="not_started",e.UnableToStart="unable_to_start",e.ClosedByJsStore="closed_by_jsstore"}(c||(c={}));var O,C=function(){function e(e){this.columns=[],this.autoIncColumnValue={},this.columns=this.setColumn(e.columns),this.name=e.name,this.alter=e.alter||{}}return e.prototype.setColumn=function(e){var t=[],n=function(n){var o=e[n];o.name=n,o.autoIncrement&&(r.autoIncColumnValue[n]=0),o.primaryKey&&(r.primaryKey=n),o.enableSearch=null==o.enableSearch||o.enableSearch;var u=r.columns.indexOf((function(e){return e.name===n}));if(u<0)t.push(o);else{var i=r.columns[u];Object.assign(i,o)}},r=this;for(var o in e)n(o);return t},e}(),j=function(){function e(){}return e.autoIncrementKey=function(e,t){return"JsStore_".concat(e,"_").concat(t,"_Value")},e.set=function(t,n,r){r.tx||r.createTransaction([e.tableName]);var o=r.objectStore(e.tableName);return f((function(e,r){var u=o.put({key:t,value:n});u.onsuccess=function(){e()},u.onerror=r}))},e.get=function(t,n){n.tx||n.createTransaction([e.tableName]);var r=n.objectStore(e.tableName);return f((function(e,o){var u=r.get(n.keyRange(t));u.onsuccess=function(){var t=u.result;e(t&&t.value)},u.onerror=o}))},e.remove=function(t,n){n.tx||n.createTransaction([e.tableName]);var r=n.objectStore(e.tableName);return f((function(e,o){var u=r.delete(n.keyRange(t));u.onsuccess=e,u.onerror=o}))},e.tableName="JsStore_Meta",e.dbSchema="JsStore_DbSchema",e}(),q=function(e){this.name=e.name,this.version=e.version||1,e.tables.push({name:j.tableName,columns:{key:{primaryKey:!0},value:{enableSearch:!1}}}),this.tables=e.tables.map((function(e){return new C(e)}))},A=function(e,t){for(var n in e)t(n,e[n])},I=function(){function e(e,t){this.type=e,this.info_=t,this.message=this.getMsg_()}return e.prototype.log=function(e){this.status&&console.log(e)},e.prototype.throw=function(){throw this.get()},e.prototype.logError=function(){console.error(this.get())},e.prototype.get=function(){return{message:this.message,type:this.type}},e.prototype.getMsg_=function(){var e,t,n=this.info_,r=((e={}).not_array=function(){t="Supplied value is not an array"},e.undefined_column=function(){t="Column is undefined in Where"},e.undefined_value=function(){t="Value is undefined in Where"},e.undefined_column_name=function(){t="Column name is undefined '"+n.TableName+"'"},e.undefined_database_name=function(){t="Database name is not supplied"},e.undefined_column_value=function(){t="Column value is undefined"},e.no_value_supplied=function(){t="No value is supplied"},e.invalid_operator=function(){t="Invalid Op Value '"+n.Op+"'"},e.column_not_exist=function(){var e=n.column;t=n.isOrder?"Column '".concat(e,"' in order query does not exist"):"Column '".concat(e,"' does not exist")},e.no_index_found=function(){t="No index found for column '"+n.column+"'. Query can not be executed without index."},e.null_value=function(){t="Null value is not allowed for column '"+n.ColumnName+"'"},e.wrong_data_type=function(){t="Supplied value for column '"+n.column+"' have wrong data type"},e.table_not_exist=function(){t="Table '"+n.tableName+"' does not exist"},e.db_not_exist=function(){t="Database with name ".concat(n.dbName," does not exist")},e.not_object=function(){t="supplied value is not object"},e.invalid_operator=function(){t="Invalid Config '"+n.Config+" '"},e.Db_blocked=function(){t="database is blocked, cant be deleted right now"},e.null_value_in_where=function(){t="Null/undefined is not allowed in where. Column '".concat(n.column,"' has null")},e.method_not_exist=function(){t="method '".concat(n,"' does not exist.")},e.indexeddb_not_supported=function(){t="Browser does not support indexeddb"},e.getInfo=function(){t=n},e.invalid_join_query=function(){r.getInfo()},e.import_scripts_failed=function(){r.getInfo()},e.invalid_middleware=function(){t="No function ".concat(n," is found.")},e),o=this.type,u=r[o];return u?u():(o||(this.type="unknown"),t=this.message),t},e}(),R=function(){function e(){this.logger=new I(null)}return e.prototype.emptyTx=function(){this.tx&&(this.tx.oncomplete=null,this.tx.onabort=null,this.tx.onerror=null,this.tx=null)},e.prototype.createTransactionIfNotExist=function(e,t){this.tx||this.createTransaction(e,t)},e.prototype.createTransaction=function(e,t){var n=this;return void 0===t&&(t=a.ReadWrite),this.tx=this.con.transaction(e,t),f((function(e,t){n.tx.oncomplete=e,n.tx.onabort=e,n.tx.onerror=t}))},e.prototype.keyRange=function(e,t){var n;switch(t){case i.Between:n=IDBKeyRange.bound(e.low,e.high,!1,!1);break;case i.GreaterThan:n=IDBKeyRange.lowerBound(e,!0);break;case i.GreaterThanEqualTo:n=IDBKeyRange.lowerBound(e);break;case i.LessThan:n=IDBKeyRange.upperBound(e,!0);break;case i.LessThanEqualTo:n=IDBKeyRange.upperBound(e);break;default:n=IDBKeyRange.only(e)}return n},e.prototype.objectStore=function(e){return this.tx.objectStore(e)},e.prototype.abortTransaction=function(){this.tx&&this.tx.abort()},e.prototype.close=function(){var e=this;return this.con&&this.con.close(),f((function(t){e.con=null,setTimeout(t,100)}))},e.prototype.initDb=function(e){var t,n=this,r=!1,o=e.version;return f((function(u,i){var a=indexedDB.open(e.name,o);a.onsuccess=function(){n.con=a.result,n.con.onversionchange=function(e){e.target.close()},u({isCreated:r,oldVersion:t,newVersion:o})},a.onerror=function(e){console.error("error",e),i(e)},a.onupgradeneeded=function(n){t=n.oldVersion;var u=n.target,i=u.result;r=!0;var a=u.transaction,s=i.objectStoreNames,c=function(e,t){var n=t.name;if(t.enableSearch&&!e.indexNames.contains(n)){var r=t.primaryKey?{unique:!0}:{unique:t.unique};r.multiEntry=t.multiEntry;var o=null==t.keyPath?n:t.keyPath;e.createIndex(n,o,r)}},l=function(e,t,n){var r=t.columns.findIndex((function(e){return e.name===n}));r>=0&&(t.columns.splice(r,1),e.deleteIndex(n))};e.tables.forEach((function(e){if(!s.contains(e.name))return function(e){var t=e.primaryKey?{keyPath:e.primaryKey}:{autoIncrement:!0},n=i.createObjectStore(e.name,t);e.columns.forEach((function(e){c(n,e)}))}(e);for(var n=a.objectStore(e.name),r=t+1;r<=o;r++){var u=e.alter[r];u&&(u.add&&e.setColumn(u.add).forEach((function(t){c(n,t),e.columns.push(t)})),A(u.drop||{},(function(t){l(n,e,t)})),A(u.modify||{},(function(t,r){var o=r.multiEntry||r.keyPath||r.unique,u=e.columns.find((function(e){return e.name===t})),i=Object.assign(u,r);i.name=t,o&&(l(n,e,t),c(n,i),e.columns.push(i))})))}}));for(var f=function(t,n){var r=s.item(t);e.tables.findIndex((function(e){return e.name===r}))<0&&i.deleteObjectStore(r)},h=0,p=s.length;h<p;h++)f(h)}}))},e}(),Q=function(e){return Promise.all(e)},N=function(e){return Promise.reject(e)},L=function(e){if(e instanceof I)return e.logError(),e.get();var t=void 0;return e.name?(t=new I(e.name)).message=e.message:(t=new I(e.target.error.name)).message=e.target.error.message,t.get()},D=function(){function e(){this.rowAffected=0,this.isTxQuery=!1,this.results=[]}return Object.defineProperty(e.prototype,"db",{get:function(){return this.util.db},enumerable:!1,configurable:!0}),e.prototype.table=function(e){var t=e||this.tableName;return this.db.tables.find((function(e){return e.name===t}))},e.prototype.primaryKey=function(e){var t=this.query;return!t.from&&t.store&&t.meta?t.meta.primaryKey:this.table(e).primaryKey},e.prototype.getColumnInfo=function(e,t){return this.table(t).columns.find((function(t){return t.name===e}))},e.prototype.onException=function(e,t){return console.error(e),this.util.abortTransaction(),N(function(e,t){return void 0===t&&(t="invalid_query"),e.name=t,L(e)}(e,t))},e}(),V=function(e){if(null==e)return r.Null;var t=typeof e;if("object"===t){if(Array.isArray(e))return r.Array;if(e instanceof Date)return r.DateTime}return t},W=function(e){return null==e||"number"==typeof e&&isNaN(e)},B=function(){function e(e,t){this.table=e,this.autoIncrementValue=t}return e.prototype.checkAndModifyValues=function(e){var t,n=this;this.query=e;var r=e.values,o=[];return r.every((function(r,u){return t=n.checkAndModifyValue(r),e.ignore&&t&&(o.push(u),t=null),!t})),o.forEach((function(e){r.splice(e,1)})),{err:t,values:r}},e.prototype.checkAndModifyValue=function(e){var t,n=this;return this.table.columns.every((function(r){return!(t=n.checkAndModifyColumnValue_(r,e))})),t},e.prototype.checkNotNullAndDataType_=function(e,t){return e.notNull&&W(t[e.name])?this.getError(v,{ColumnName:e.name}):e.dataType&&!W(t[e.name])&&V(t[e.name])!==e.dataType?this.getError(m,{column:e.name}):void 0},e.prototype.checkAndModifyColumnValue_=function(e,t){var n=t[e.name];if(e.autoIncrement?W(n)?t[e.name]=++this.autoIncrementValue[e.name]:V(n)===r.Number&&n>this.autoIncrementValue[e.name]&&(this.autoIncrementValue[e.name]=n):void 0!==e.default&&W(n)&&(t[e.name]=e.default),this.query.validation)return this.checkNotNullAndDataType_(e,t)},e.prototype.getError=function(e,t){return new I(e,t)},e}(),P=function(){function e(e){this.table=e}return e.prototype.check=function(e,t){var n,o=this;return typeof e===r.Object?this.table?this.table.columns.every((function(t){return t.name in e&&(n=o.checkByColumn_(t,e[t.name])),!n})):n=new I(b,{tableName:t}):n=new I(g),n},e.prototype.checkByColumn_=function(e,t){if(!0===e.notNull&&W(t))return new I(v,{ColumnName:e.name});var n=V(t),r=null!=t;if(e.dataType&&r&&n!==e.dataType&&"object"!==n)return new I(m,{column:e.name});if(r&&"object"===n){var o=["+","-","*","/","{push}"];for(var u in t)if(o.indexOf(u)<0&&e.dataType&&n!==e.dataType)return new I(m,{column:e.name})}},e}(),M=function(){function e(e){this.db=e}return e.prototype.validate=function(e,t){switch(e){case o.Select:case o.Remove:case o.Count:return this.checkSelect(t);case o.Insert:return this.checkInsertQuery(t);case o.Update:return this.checkUpdate(t)}},e.prototype.getTable_=function(e){return this.db.tables.find((function(t){return t.name===e}))},e.prototype.isInsertQryValid=function(e){var t,n=this.getTable_(e.into);if(n)switch(V(e.values)){case r.Array:break;case r.Null:t=new I(p);break;default:t=new I(h)}else t=new I(b,{tableName:e.into});return{table:n,log:t}},e.prototype.checkUpdate=function(e){var t=new P(this.getTable_(e.in)).check(e.set,e.in);if(t)return t;if(null!=e.where){if(t=this.checkForNullInWhere_(e))return t;this.addGreatAndLessToNotOp_(e)}},e.prototype.checkSelect=function(e){if(!e.store&&!this.getTable_(e.from))return new I(b,{tableName:e.from});if(e.where){var t=this.checkForNullInWhere_(e);if(t)return t;this.addGreatAndLessToNotOp_(e)}},e.prototype.checkForNullInWhere_=function(e){for(var t in e.where)if(null==e.where[t])return new I(x,{column:t})},e.prototype.addGreatAndLessToNotOp_=function(e){var t=e.where,n=function(e,t){return t.findIndex((function(t){return null!=e[t][i.NotEqualTo]}))>=0},o=function(e,t){var n;return t.forEach((function(t){null!=(n=e[t])[i.NotEqualTo]&&(e[t][i.GreaterThan]=n[i.NotEqualTo],void 0===e[i.Or]?(e[i.Or]={},e[i.Or][t]={}):void 0===e[i.Or][t]&&(e[i.Or][t]={}),e[i.Or][t][i.LessThan]=n[i.NotEqualTo],delete e[t][i.NotEqualTo])})),e};if(V(t)===r.Object){var u=Object.keys(t);if(n(t,u))if(1===u.length)e.where=o(t,u);else{var a=[];u.forEach((function(e){var n;a.push(o(((n={})[e]=t[e],n),[e]))})),e.where=a}}else{var s=[];t.forEach((function(e){var t=Object.keys(e);n(e,t)&&(e=o(e,t)),s.push(e)})),e.where=s}},e.prototype.checkInsertQuery=function(e){var t=this.isInsertQryValid(e),n=t.table,r=t.log;if(r)return r;if(!e.skipDataCheck){var o=new B(n,n.autoIncColumnValue).checkAndModifyValues(e),u=o.values,i=o.err;return e.values=u,i}},e}(),K=(O=function(e,t){return O=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},O(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}O(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),G=function(e){function t(t,n){var r=e.call(this)||this;return r.valuesAffected_=[],null==t.validation&&(t.validation=!0),r.query=t,r.util=n,r.tableName=t.into,r}return K(t,e),t.prototype.execute=function(e){var t=this,n=this.db,r=new M(n).validate(o.Insert,this.query);return r?N(r):e().then((function(e){return t.insertData_(n).then((function(e){return t.query.return?t.valuesAffected_:t.rowAffected}))})).catch((function(e){return t.util.abortTransaction(),N(e)}))},t.prototype.insertData_=function(e){var t,n,r,o=this,u=this.query;return t=u.return?function(e){o.valuesAffected_.push(e)}:function(e){++o.rowAffected},r=u.upsert?"put":"add",n=u.ignore&&!o.isTxQuery?function(e){return o.util.con.transaction(u.into,a.ReadWrite).objectStore(u.into)[r](e)}:(o.isTxQuery||o.util.createTransaction([u.into,j.tableName]),o.objectStore=o.util.objectStore(o.tableName),function(e){return o.objectStore[r](e)}),Q(u.values.map((function(e){return f((function(r,o){var i=n(e);i.onerror=function(e){u.ignore?r():o(e)},i.onsuccess=function(){t(e),r()}}))}))).then((function(){j.set(j.dbSchema,e,o.util)}))},t}(D),F=void 0===self.alert&&"undefined"==typeof ServiceWorkerGlobalScope,U=function(){try{if(indexedDB||(indexedDB=self.mozIndexedDB||self.webkitIndexedDB||self.msIndexedDB),!indexedDB)return!1;IDBTransaction=IDBTransaction||self.webkitIDBTransaction||self.msIDBTransaction,self.IDBKeyRange=self.IDBKeyRange||self.webkitIDBKeyRange||self.msIDBKeyRange}catch(e){return!1}return!0}(),J=function(e){return Array.isArray(e)},z=function(e){return Object.keys(e)},$=function(e){return z(e).length},H=function(e){for(var t in e)return t},X=function(){function e(){}return e.prototype.setCaseAndValue=function(e,t){this.caseQuery_=e,this.setValue(t)},e.prototype.setCaseAndColumn=function(e,t){return this.caseQuery_=e,this.setColumn(t),this},e.prototype.setColumn=function(e){return this.columnName_=e,this.caseColumnQuery_=this.caseQuery_[this.columnName_],this.length_=this.caseColumnQuery_.length,this},e.prototype.setValue=function(e){return this.value=e,this},e.prototype.evaluate=function(){for(var e=0;e<this.length_;e++)if(!0===this.checkCase_(this.caseColumnQuery_[e]))return this.caseColumnQuery_[e].then;var t=this.caseColumnQuery_[this.length_-1].then;return null==t?this.value[this.columnName_]:t},e.prototype.checkCase_=function(e){var t;for(t in e){switch(t){case i.GreaterThan:if(this.value[this.columnName_]>e[t])return!0;break;case i.Equal:if(this.value[this.columnName_]===e[t])return!0;break;case i.LessThan:if(this.value[this.columnName_]<e[t])return!0;break;case i.GreaterThanEqualTo:if(this.value[this.columnName_]>=e[t])return!0;break;case i.LessThanEqualTo:if(this.value[this.columnName_]<=e[t])return!0;break;case i.NotEqualTo:if(this.value[this.columnName_]!==e[t])return!0;break;case i.Between:if(this.value[this.columnName_]>e[t].low&&this.value[this.columnName_]<e[t].high)return!0}return!1}},e}(),Y=function(e,t,n,r){if(!1===this.limitAtEnd&&!1===this.skipAtEnd){if(this.skipRecord)return this.limitRecord?r:n;if(this.limitRecord)return t}return e},Z=function(e){var t=this,n=!1;return function(r){var o=r.target.result;o?n&&t.results.length!==t.limitRecord?(t.shouldAddValue(o)&&t.pushResult(o.value),o.continue()):(n=!0,o.advance(t.skipRecord)):e()}},ee=function(e){var t=this,n=!1;return function(r){var o=r.target.result;o?n?(t.shouldAddValue(o)&&t.pushResult(o.value),o.continue()):(n=!0,o.advance(t.skipRecord)):e()}},te=function(e){var t=this;return function(n){var r=n.target.result;r&&t.results.length!==t.limitRecord?(t.shouldAddValue(r)&&t.pushResult(r.value),r.continue()):e()}},ne=function(e){var t=this;return function(n){var r=n.target.result;r?(t.shouldAddValue(r)&&t.pushResult(r.value),r.continue()):e()}},re=function(e){var t,n=this,r=!1;return function(o){(t=o.target.result)?r&&n.results.length!==n.limitRecord?(n.pushResult(t.value),t.continue()):(r=!0,t.advance(n.skipRecord)):e()}},oe=function(e){var t,n=this,r=!1;return function(o){(t=o.target.result)?r?(n.pushResult(t.value),t.continue()):(r=!0,t.advance(n.skipRecord)):e()}},ue=function(e){var t,n=this;return function(r){(t=r.target.result)?(n.pushResult(t.value),t.continue()):e()}},ie=function(e){var t,n=this;return function(r){(t=r.target.result)&&n.results.length!==n.limitRecord?(n.pushResult(t.value),t.continue()):e()}},ae=function(e){return e.replace(/\s/g,"")},se=function(e){var t;if(!this.query.store)if(null==this.query.join)t=this.getColumnInfo(e);else{var n=ae(e).split("."),r=n[1];t=this.getColumnInfo(r,n[0])}if(null==t){var o=this.results[0][e];if(o)return{dataType:V(o),name:e};throw new I(y,{column:e,isOrder:!0})}return t},ce=function(e,t){return t.localeCompare(e)},le=function(e,t){return e.localeCompare(t)},fe=function(e,t){return new String(t).localeCompare(e)},he=function(e,t){return new String(e).localeCompare(t)},pe=function(e,t){return t-e},ye=function(e,t){return e-t},de=function(e,t){return t.getTime()-e.getTime()},ve=function(e,t){return e.getTime()-t.getTime()},me=function(e,t){switch(e.dataType){case r.String:return"asc"===t.type?le:ce;case r.Number:return"asc"===t.type?ye:pe;case r.DateTime:return"asc"===t.type?ve:de;default:return"asc"===t.type?he:fe}},be=function(e){var t;e.type=ge(e.type);var n=e.by,o=this.thenEvaluator;if(null!=n&&typeof n===r.Object){var u=n,i=function(e,t){return function(n,i){for(var a in u){o.setCaseAndValue(u,n);var s=o.setColumn(a).evaluate();o.setCaseAndValue(u,i);var c=o.setColumn(a).evaluate();return typeof n[s]===r.String?e(n[s],i[c]):t(n[s],i[c])}}},a="asc"===e.type?i(le,ye):i(ce,pe);this.results.sort(a)}else{var s=se.call(this,n);if(null!=s){var c=me(s,e);n=s.name,null==e.case?this.results.sort((function(e,t){return c(e[n],t[n])})):(o.setCaseAndColumn(((t={})[n]=e.case,t),n),this.results.sort((function(e,t){return c(o.setValue(e).evaluate(),o.setValue(t).evaluate())})))}}},ge=function(e){return null==e?"asc":e.toLowerCase()},_e=function(e){var t,n,r=e.split("%");switch(r[1]?(t=r[1],n=r.length>2?s.Any:s.Last):(t=r[0],n=s.First),n){case s.First:return new RegExp("^".concat(t),"i");case s.Last:return new RegExp("".concat(t,"$"),"i");default:return new RegExp("".concat(t),"i")}},we=function(e){return"object"===V(e)&&!(e instanceof RegExp)},xe=function(e){if(we(e)){var t={};for(var n in e)t[n]=null!=e[n]&&we(e[n])?xe(e[n]):e[n];return t}return e},ke=function(e,t,n){var o=V(e);if(o!==V(t))return!1;switch(o===r.DateTime&&(e=e.getTime(),t=t.getTime()),n){case i.GreaterThan:return e>t;case i.LessThan:return e<t;case i.LessThanEqualTo:return e<=t;case i.GreaterThanEqualTo:return e>=t;case i.NotEqualTo:return e!==t;default:return e===t}},Te=function(){function e(e,t){this.where=xe(e),this.checkFlag=t}return e.prototype.remove=function(e){var t=e.pop();delete e.reduce((function(e,t){return e&&e[t]}),this.where)[t]},e.prototype.check=function(e){var t=!0;if(!this.checkFlag)return t;for(var n in this.where){if(!t)return t;var r=this.where[n],o=e[n];if("object"===V(r))for(var u in r){if(!t)return t;switch(u){case i.In:t=this.checkIn(n,o);break;case i.Like:t=this.checkLike_(n,o);break;case i.Regex:t=this.checkRegex(n,o);break;case i.Between:case i.GreaterThan:case i.LessThan:case i.GreaterThanEqualTo:case i.LessThanEqualTo:case i.NotEqualTo:t=this.checkComparisionOp_(n,o,u);break;default:t=!1}}else t=ke(r,o)}return t},e.prototype.checkIn=function(e,t){return null!=this.where[e][i.In].find((function(e){return ke(e,t)}))},e.prototype.checkLike_=function(e,t){return _e(this.where[e][i.Like]).test(t)},e.prototype.checkRegex=function(e,t){return this.where[e][i.Regex].test(t)},e.prototype.checkComparisionOp_=function(e,t,n){var r=this.where[e][n];return n!=i.Between?ke(t,r,n):ke(t,r.low,">=")&&ke(t,r.high,"<=")},e}(),Se=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ee=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.limitAtEnd=!1,t.skipAtEnd=!1,t}return Se(t,e),t.prototype.goToWhereLogic=function(){var e=this,t=this.query,n=t.where,r=function(){for(var t in n)if(e.objectStore.indexNames.contains(t))return t}();if(null==r&&(r=H(n),!t.store))return N(new I(d,{column:r}));var o=n[r];if("object"!==V(o))return u=$(n)>1,this.whereChecker=new Te(n,u),this.whereChecker.remove([r]),this.executeWhereLogic(r,o,null,"next");var u=$(o)>1||$(n)>1;this.whereChecker=new Te(n,u);var a=H(o);switch(this.whereChecker.remove([r,a]),a){case i.Like:var s=_e(o[i.Like]);return this.executeRegexLogic(r,s);case i.Regex:return this.executeRegexLogic(r,o[i.Regex]);case i.In:return this.executeInLogic(r,o[i.In]);case i.Between:case i.GreaterThan:case i.LessThan:case i.GreaterThanEqualTo:case i.LessThanEqualTo:return this.executeWhereLogic(r,o,a,"next");case i.Aggregate:break;default:return this.executeWhereLogic(r,o,null,"next")}},t}(D),Oe=function(e,t){var n=this;return function(r){var o=r.target.result;n.results.length!==n.limitRecord&&o?(n.shouldAddValue(o)&&t(o.value),o.continue()):e()}},Ce=function(e,t){var n=this;return function(r){var o=r.target.result;o?(n.shouldAddValue(o)&&t(o.value),o.continue()):e()}},je=function(){return je=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},je.apply(this,arguments)},qe=function(){function e(e){this.joinQueryStack_=[],this.currentQueryStackIndex_=0,this.tablesFetched=[],this.results=[],this.select=e}return Object.defineProperty(e.prototype,"query",{get:function(){return this.select.query},enumerable:!1,configurable:!0}),e.prototype.getTable=function(e){return this.select.table(e)},e.prototype.executeSelect=function(e){return new Ne(e,this.select.util).execute()},e.prototype.execute=function(){var e=this,t=this.query;this.joinQueryStack_=V(t.join)===r.Object?[t.join]:t.join;var n=t.from,o=[];n&&o.push(n);for(var u=this.joinQueryStack_,i=0,a=u.length;i<a;i++){var s=u[i],c=this.getJoinTableInfo_(s.on);s.with===c.table1.table&&(c={table1:c.table2,table2:c.table1});var l=this.checkJoinQuery_(c,s);if(l)return N(l);u[i].joinTableInfo=c,s.with&&o.push(s.with)}return!this.select.isTxQuery&&o.length>0&&this.select.util.createTransaction(o),this.executeSelect({from:n,where:t.where,case:t.case,flatten:t.flatten,store:t.store,meta:t.meta}).then((function(t){return e.results=t.map((function(t){var n;return(n={})[e.currentQueryStackIndex_]=t,n})),e.tablesFetched.push(u[0].joinTableInfo.table1.table),e.startExecutingJoinLogic_()}))},e.prototype.onJoinQueryFinished_=function(){if(0!==this.results.length){var e=this.select;try{var t=[],n=z(this.results[0]).length;this.results.forEach((function(e){for(var r=e[0],o=1;o<n;o++)r=je(je({},r),e[o]);t.push(r)})),e.results=t,e.setLimitAndSkipEvaluationAtEnd_(),e.query.flatten=null,e.processOrderBy()}catch(e){return N(new I(k,e.message))}}},e.prototype.startExecutingJoinLogic_=function(){var e=this,t=this.joinQueryStack_[this.currentQueryStackIndex_];if(!t)return this.onJoinQueryFinished_();try{var n=t.joinTableInfo;return this.executeSelect({from:t.with,where:t.where,case:t.case,flatten:t.flatten,store:t.store,meta:t.meta}).then((function(r){return e.jointables(t,n,r),e.tablesFetched.push(n.table2.table),++e.currentQueryStackIndex_,e.startExecutingJoinLogic_()}))}catch(e){return N(new I(k,e.message))}},e.prototype.jointables=function(e,t,n){var r,o=this,u=e.type,i=[],a=t.table1.column,s=t.table2.column,c=this.tablesFetched.indexOf(t.table1.table),l=this.currentQueryStackIndex_+1,f=e.as,h=f?function(e){for(var t in f){var n=f[t];void 0===e[n]&&(e[n]=e[t],delete e[t])}return e}:function(e){return e};"left"===u?function(){var r,u,f=0,p={};e.store?z(e.store).forEach((function(e){p[e]=null})):o.getTable(t.table2.table).columns.forEach((function(e){p[e.name]=null})),u=1===l?function(e,t){t[c][a]===e[s]&&r.push(e)}:function(e,t){var n=t[c];null!=n&&n[a]===e[s]&&r.push(e)};var y=Object.assign(e.where||{},e.whereJoin||{}),d=new Te(y,$(y)>0);o.results.forEach((function(e){r=[],n.forEach((function(t){u(t,e)})),0===r.length&&(r=[p]),r.forEach((function(t){t=h(t),d.check(t)&&(i[f]=je({},e),i[f++][l]=t)}))}))}():(r=0,o.results.forEach((function(e){n.forEach((function(t){e[c][a]===t[s]&&(i[r]=je({},e),i[r++][l]=h(je({},t)))}))}))),this.results=i},e.prototype.getJoinTableInfo_=function(e){var t=(e=ae(e)).split("="),n=t[0].split("."),r=t[1].split(".");return{table1:{table:n[0],column:n[1]},table2:{table:r[0],column:r[1]}}},e.prototype.checkJoinQuery_=function(e,t){if(t.store)return null;var n,r=e.table1,o=e.table2,u=this.getTable(r.table),i=this.getTable(o.table);t.with!==o.table&&(n=new I(k,"on value should contains value of with")),null==u.columns.find((function(e){return e.name===r.column}))?n=new I(k,"column ".concat(r.column," does not exist in table ").concat(r.table)):null==i.columns.find((function(e){return e.name===o.column}))&&(n=new I(k,"column ".concat(o.column," does not exist in table ").concat(o.table))),null==t.as&&(t.as={}),u.columns.every((function(e){var u=i.columns.find((function(t){return t.name===e.name&&t.name!==r.column}));return null==u||null!=t.as[u.name]||(n=new I(k,"column ".concat(e.name," exist in both table ").concat(r.table," & ").concat(o.table)),!1)}));var a=t.where;if(a){var s={},c=function(e){i.columns.find((function(t){return t.name===e}))||(s[e]=a[e],delete a[e])};for(var l in a)c(l);t.whereJoin=s,0===$(a)&&(t.where=null)}return n},e}(),Ae=function(){function e(e){this.data=e}return Object.defineProperty(e.prototype,"indexNames",{get:function(){var e=z(this.data[0]);return{contains:function(t){return e.indexOf(t)>=0}}},enumerable:!1,configurable:!0}),e.prototype.index=function(e){var t=this;return{openCursor:function(n){var r={},o=0,u={continue:function(){++o,a()}},i=function(e){r.onsuccess({target:{result:e}})},a=function(){var r=t.data[o];if(r){var a=r[e];a&&(null==n||n.includes(a))?(u.key=a,u.value=r,i(u)):u.continue()}else i(null)};return l().then(a),r}}},e}(),Ie=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Re=function(){return Re=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},Re.apply(this,arguments)},Qe=function(e,t,n){if(n||2===arguments.length)for(var r,o=0,u=t.length;o<u;o++)!r&&o in t||(r||(r=Array.prototype.slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))},Ne=function(e){function t(t,n){var r=e.call(this)||this;r.sorted=!1,r.isSubQuery=!1,r.thenEvaluator=new X,r.returnResult_=function(){if(r.results.length>0){var e=r.query;if(e.flatten){var t=[],n=new Map;e.flatten.forEach((function(e){r.results.forEach((function(r,o){r[e].forEach((function(n){var o;t.push(Re(Re({},r),((o={})[e]=n,o)))})),n.set(o,!0)}))}));var o=0;n.forEach((function(e,t){r.results.splice(t-o,1),++o})),r.results=r.results.concat(t)}r.processGroupDistinctAggr(),r.processOrderBy(),r.skipAtEnd&&r.results.splice(0,e.skip),r.limitAtEnd&&(r.results=r.results.slice(0,e.limit))}return r.results},r.query=t,r.util=n,r.tableName=t.from,r.setPushResult(),J(t.where)?(r.isArrayQry=!0,r.setLimitAndSkipEvaluationAtEnd_()):(r.skipRecord=t.skip,r.limitRecord=t.limit);var o=t.order;return o?((J(o)||o.case||"object"==typeof o.by)&&(o.idbSorting=!1),r.setLimitAndSkipEvaluationAtEnd_()):t.groupBy&&r.setLimitAndSkipEvaluationAtEnd_(),r}return Ie(t,e),t.prototype.execute=function(e){var t=this;e||(e=function(){return l(null)});var n=this.query;try{var r=new M(this.db).validate(o.Select,n);return r?N(r):e().then((function(e){return t.initTransaction_(),(null==n.join?null!=n.where?J(n.where)?t.processWhereArrayQry():t.processWhere_():t.executeWhereUndefinedLogic():t.executeJoinQuery()).then(t.returnResult_.bind(t))}))}catch(e){return this.onException(e)}},t.prototype.processWhereArrayQry=function(){var e=this;this.isArrayQry=!0;var t,n=this.query.where,r=this.primaryKey(),o=!0,u=[],a=function(){var a;if(t===i.And?!0===o?u=e.results:u.length>0&&(a=[],e.results.forEach((function(e){var t;t=e[r],u.findIndex((function(e){return e[r]===t}))>=0&&a.push(e)})),u=a,a=null):u.length>0?(e.results=Qe(Qe([],u,!0),e.results,!0),e.removeDuplicates(),u=e.results):u=e.results,o=!1,n.length>0)return e.results=[],s();e.results=u},s=function(){var r=n.shift();return r[i.Or]&&1===$(r)?(t=i.Or,r=r[i.Or]):t=i.And,e.query.where=r,e.processWhere_().then(a)};return s()},t.prototype.initTransaction_=function(){var e=this.query.store;e?this.objectStore=new Ae(e):(this.isTxQuery||this.util.createTransactionIfNotExist([this.tableName],a.ReadOnly),this.objectStore=this.util.objectStore(this.tableName))},t.prototype.processWhere_=function(){var e=this;return this.shouldAddValue=function(t){return e.whereChecker.check(t.value)},this.query.where.or&&this.processOrLogic_(),this.goToWhereLogic().then((function(){return e.onWhereEvaluated()}))},t.prototype.onWhereEvaluated=function(){if(this.isOr)return this.orQuerySuccess_()},t.prototype.orQueryFinish_=function(){this.isOr=!1,this.results=this.orInfo.results,this.orInfo=null,this.removeDuplicates()},t.prototype.orQuerySuccess_=function(){var e=this.query;this.results.length>0&&(this.orInfo.results=Qe(Qe([],this.orInfo.results,!0),this.results,!0)),this.results=[];var t=H(this.orInfo.orQuery);if(null!=t){var n={};return n[t]=this.orInfo.orQuery[t],delete this.orInfo.orQuery[t],e.where=n,this.goToWhereLogic().then(this.onWhereEvaluated.bind(this))}return this.orQueryFinish_()},t.prototype.processOrLogic_=function(){this.isOr=!0;var e=this.query.where;this.orInfo={orQuery:e.or,results:[]},this.setLimitAndSkipEvaluationAtEnd_(),delete e.or},t}(Ee);Ne.prototype.executeInLogic=function(e,t){var n=this,r=this.skipRecord,o=function(e){0===r?n.pushResult(e):--r},u=Y.call(this,ne,te,Ce,Oe);return Q(t.map((function(t){return f((function(r,i){var a=n.objectStore.index(e).openCursor(n.util.keyRange(t));a.onsuccess=u.call(n,r,o),a.onerror=i}))})))},Ne.prototype.executeWhereUndefinedLogic=function(){var e,t=this,n=this.query,r=n.store;if(r)return this.results=r,this.setLimitAndSkipEvaluationAtEnd_(),l();var o=n.order,u=this.objectStore;if(o&&!1!==o.idbSorting&&o.by){if(!u.indexNames.contains(o.by))return N(new I(y,{column:o.by,isOrder:!0}));var i=o.type&&"desc"===o.type.toLowerCase()?"prev":"next";this.sorted=!0,e=u.index(o.by).openCursor(null,i)}else e=u.openCursor();var a=Y.call(this,ue,ie,oe,re);return f((function(n,r){e.onerror=r,e.onsuccess=a.call(t,n)}))},Ne.prototype.executeWhereLogic=function(e,t,n,r){var o=this;t=n?t[n]:t;var u=this.objectStore.index(e).openCursor(this.util.keyRange(t,n),r),i=Y.call(this,ne,te,ee,Z);return f((function(e,t){u.onerror=t,u.onsuccess=i.call(o,e)}))},Ne.prototype.executeRegexLogic=function(e,t){var n=this,r=this.skipRecord,o=function(e){0===r?n.pushResult(e):--r};this.shouldAddValue=function(e){return t.test(e.key)&&n.whereChecker.check(e.value)};var u=this.objectStore.index(e).openCursor(),i=Y.call(this,ne,te,Ce,Oe);return f((function(e,t){u.onerror=t,u.onsuccess=i.call(n,e,o)}))},Ne.prototype.setLimitAndSkipEvaluationAtEnd_=function(){this.query.limit&&(this.limitAtEnd=!0),this.query.skip&&(this.skipAtEnd=!0)},Ne.prototype.setPushResult=function(){var e=this,t=this.query.case;this.pushResult=t?function(n){var r;for(r in e.thenEvaluator.setCaseAndValue(t,n),t)n[r]=e.thenEvaluator.setColumn(r).evaluate();e.results.push(n)}:function(t){e.results.push(t)}},Ne.prototype.removeDuplicates=function(){for(var e=this.results,t=this.primaryKey(),n=new Map,r=0,o=e.length;r<o;r++)n.set(e[r][t],e[r]);this.results=Array.from(n.values())},Ne.prototype.executeJoinQuery=function(){return new qe(this).execute()},Ne.prototype.processGroupDistinctAggr=function(){var e=this.query;if(e.distinct){var t=[],n=this.results[0];for(var r in n)t.push(r);var o=this.primaryKey(),u=t.indexOf(o);t.splice(u,1),e.groupBy=t.length>0?t:null}e.groupBy?e.aggregate?this.executeAggregateGroupBy():this.processGroupBy():e.aggregate&&this.processAggregateQry()},Ne.prototype.processOrderBy=function(){var e=this.query.order;if(e&&this.results.length>0&&!this.sorted){var t=V(e);if(t===r.Object)be.call(this,e);else if(t===r.Array){be.call(this,e[0]);for(var n=function(t,n){var r=e[t-1].by,u=e[t],i=u.by,a=se.call(o,i);if(null!=a){i=a.name,u.type=ge(u.type);var s=me(a,u);o.results.sort((function(e,t){return e[r]===t[r]?s(e[i],t[i]):0}))}},o=this,u=1,i=e.length;u<i;u++)n(u)}}},Ne.prototype.processAggregateQry=function(){var e,t=this.results,n=t.length,o={},u=function(){var n=0;for(var r in t)n+=t[r][e]?1:0;return n},i=function(){var n=0;for(var r in t)n=n>t[r][e]?n:t[r][e];return n},a=function(){var n=1/0,r=1/0;for(var o in t)n=n<(r=t[o][e]?t[o][e]:1/0)?n:r;return n},s=function(){var n=0;for(var r in t)n+=t[r][e];return n},c=function(){return s()/n},l=this.query.aggregate;for(var f in l){var h=l[f],p=V(h),y=void 0;switch(f){case"count":y=u;break;case"max":y=i;break;case"min":y=a;break;case"sum":y=s;break;case"avg":y=c}switch(p){case r.String:e=h,o["".concat(f,"(").concat(e,")")]=y();break;case r.Array:for(var d in h)e=h[d],o["".concat(f,"(").concat(e,")")]=y()}}for(var f in o)t[0][f]=o[f];this.results=[t[0]]},Ne.prototype.executeAggregateGroupBy=function(){var e,t,n,o,u=this.query.groupBy,a=this.results,s=new Map,c=this.query.aggregate,l=function(){var u=function(){return n=(n=s.get(t))?n["count("+o+")"]:0,n+=a[e][o]?1:0},l=function(){return(n=(n=s.get(t))?n["list("+o+")"]:[]).push(a[e][o]),n},f=function(){return n=(n=s.get(t))?n["max("+o+")"]:0,a[e][o]=a[e][o]?a[e][o]:0,n>a[e][o]?n:a[e][o]},h=function(){return n=(n=s.get(t))?n["min("+o+")"]:1/0,a[e][o]=a[e][o]?a[e][o]:1/0,n<a[e][o]?n:a[e][o]},p=function(){return n=(n=s.get(t))?n["sum("+o+")"]:0,n+=a[e][o]?a[e][o]:0},y=function(){var r=(n=s.get(t))?n["sum("+o+")"]:0;r+=a[e][o]?a[e][o]:0,a[e]["sum("+o+")"]=r,n=n?n["count("+o+")"]:0,n+=a[e][o]?1:0,a[e]["count("+o+")"]=n};for(var d in c){var v=c[d],m=V(v),b=void 0;switch(d){case i.Count:b=u;break;case i.Max:b=f;break;case i.Min:b=h;break;case i.Sum:b=p;break;case i.Avg:b=y;break;case i.List:b=l}switch(m){case r.String:o=v,a[e]["".concat(d,"(").concat(o,")")]=b();break;case r.Array:for(var g in v)o=v[g],a[e]["".concat(d,"(").concat(o,")")]=b()}}};if(V(u)===r.String)for(e in a)t=a[e][u],l(),s.set(t,a[e]);else for(e in a){for(var f in t="",u)t+=a[e][u[f]];l(),s.set(t,a[e])}a=Array.from(s.values());var h=c.avg;if(h)if(V(h)===r.String)for(e in a){var p=a[e]["sum("+h+")"],y=a[e]["count("+h+")"];a[e]["avg("+h+")"]=p/y,c.count!==h&&delete a[e]["count("+h+")"],c.sum!==h&&delete a[e]["sum("+h+")"]}else{var d=V(c.count)===r.String,v=V(c.sum)===r.String;for(e in a)for(var f in h){var m=h[f],b=a[e]["sum("+m+")"],g=a[e]["count("+m+")"];a[e]["avg("+m+")"]=b/g,d&&(c.count!==m||-1===c.count.indexOf(m))&&delete a[e]["count("+m+")"],v&&(c.sum!==m||-1===c.sum.indexOf(m))&&delete a[e]["sum("+m+")"]}}this.results=a},Ne.prototype.processGroupBy=function(){var e=this.query.groupBy,t=this.results,n=new Map,o=V(e);if(o!==r.Object)if(o===r.String)for(var u in t)n.set(t[u][e],t[u]);else{var i=void 0;for(var u in t){for(var a in i="",e)i+=t[u][e[a]];n.set(i,t[u])}}else if(1===Object.keys(e).length){var s=H(e);for(var u in this.thenEvaluator.setCaseAndColumn(e,s),t)n.set(this.thenEvaluator.setValue(t[u]).evaluate(),t[u])}else for(var u in i=void 0,t){for(var a in i="",this.thenEvaluator.setCaseAndValue(e,t[u]),e)i+=this.thenEvaluator.setColumn(a).evaluate();n.set(i,t[u])}this.results=Array.from(n.values())};var Le=function(e){var t=this;return function(n){var r=n.target.result;r?(t.shouldAddValue(r)&&++t.resultCount,r.continue()):e()}},De=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ve=function(e){function t(t,n){var r=e.call(this)||this;return r.resultCount=0,r.query=t,r.util=n,r.tableName=t.from,r}return De(t,e),t.prototype.execute=function(e){var t=this,n=new M(this.db),r=this.query,u=n.validate(o.Count,r);return u?N(u):e().then((function(e){var n;try{var o=function(){var e=new Ne(r,t.util);return e.isTxQuery=t.isTxQuery,e.execute().then((function(e){t.resultCount=e.length}))};t.initTransaction_(),null==r.join?null!=r.where?r.where.or||J(r.where)?n=o():(t.shouldAddValue=function(e){return t.whereChecker.check(e.value)},n=t.goToWhereLogic()):n=t.executeWhereUndefinedLogic():n=o()}catch(e){t.onException(e)}return n.then((function(e){return t.resultCount}))}))},t.prototype.initTransaction_=function(){var e=this.query.from;this.isTxQuery||this.util.createTransaction([e],a.ReadOnly),this.objectStore=this.util.objectStore(e)},t}(Ee);Ve.prototype.executeWhereUndefinedLogic=function(){var e,t,n=this,r=this.objectStore,o=r.count?(e=r.count(),function(t){return function(){n.resultCount=e.result,t()}}):(e=r.openCursor(),function(e){return function(r){(t=r.target.result)?(++n.resultCount,t.continue()):e()}});return f((function(t,n){e.onerror=n,e.onsuccess=o(t)}))},Ve.prototype.executeWhereLogic=function(e,t,n){var r,o=this;t=n?t[n]:t;var u=1===$(this.query.where),i=this.objectStore;return f((function(a,s){u&&i.count?(r=i.index(e).count(o.util.keyRange(t,n))).onsuccess=function(){o.resultCount=r.result,a()}:(r=i.index(e).openCursor(o.util.keyRange(t,n))).onsuccess=Le.call(o,a),r.onerror=s}))},Ve.prototype.executeRegexLogic=function(e,t){var n=this,r=this.objectStore.index(e).openCursor();return this.shouldAddValue=function(e){return t.test(e.key)&&n.whereChecker.check(e.value)},f((function(e,t){r.onerror=t,r.onsuccess=Le.call(n,e)}))},Ve.prototype.executeInLogic=function(e,t){var n=this,r=this.objectStore,o=r.index(e),u=1===$(this.query.where);return Q(t.map((function(e){return t=e,i=n.util.keyRange(t),u&&r.count?f((function(e,t){var r=o.count(i);r.onsuccess=function(t){n.resultCount+=t.target.result,e()},r.onerror=t})):f((function(e,t){var r=o.openCursor(i);r.onsuccess=Le.call(n,e),r.onerror=t}));var t,i})))};var We=function(e){return(J(e)?e:e.split(".")).reduce((function(e,t){return e&&e[t]}),self)},Be=function(e,t){var n=e.set,o=e.mapSet;if(o){var u=o(n,t);null!=u&&(n=u)}for(var i in n){var a=n[i];if(V(a)!==r.Object)t[i]=a;else for(var s in a){var c=a[s];switch(s){case"+":t[i]+=c;break;case"-":t[i]-=c;break;case"*":t[i]*=c;break;case"/":t[i]/=c;break;case"{push}":t[i].push(c);break;default:t[i]=a}break}}return t},Pe=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Me=function(e){function t(t,n){var o=e.call(this)||this;o.query=t,o.util=n,o.tableName=t.in;var u=t.mapSet;if(u){var i=V(u)===r.String?We(u):u;if(!i)throw new I(S,u);t.mapSet=i}return o}return Pe(t,e),t.prototype.execute=function(e){var t=this,n=this.query;try{var r=new M(this.db).validate(o.Update,n);return r?N(r):e().then((function(e){return t.initTransaction(),(null!=n.where?n.where.or||J(n.where)?t.executeComplexLogic_():t.goToWhereLogic():t.executeWhereUndefinedLogic()).then((function(){return t.rowAffected}))}))}catch(e){return this.onException(e)}},t.prototype.executeComplexLogic_=function(){var e=this,t=this.query,n=new Ne({from:t.in,where:t.where,ignoreCase:t.ignoreCase},this.util);return n.isTxQuery=this.isTxQuery,n.execute().then((function(n){var r,o,u=e.primaryKey(t.in),a=[];n.forEach((function(e){a.push(e[u])})),n=null;var s=((r={})[u]=((o={})[i.In]=a,o),r);return e.query.where=s,e.initTransaction(),e.goToWhereLogic()}))},t.prototype.initTransaction=function(){var e=this.query.in;this.isTxQuery||this.util.createTransaction([e]),this.objectStore=this.util.objectStore(e)},t}(Ee);Me.prototype.executeWhereUndefinedLogic=function(){var e=this,t=this.objectStore.openCursor();return f((function(n,r){t.onsuccess=function(t){var o=t.target.result;if(o)try{var u=o.update(Be(e.query,o.value));u.onsuccess=function(){++e.rowAffected,o.continue()},u.onerror=r}catch(e){r(e)}else n()},t.onerror=r}))},Me.prototype.executeWhereLogic=function(e,t,n){var r=this,o=this.query;t=n?t[n]:t;var u=this.objectStore.index(e).openCursor(this.util.keyRange(t,n));return f((function(e,t){u.onsuccess=function(n){var u=n.target.result;if(u)if(r.whereChecker.check(u.value))try{var i=u.update(Be(o,u.value));i.onsuccess=function(){++r.rowAffected,u.continue()},i.onerror=t}catch(e){t(e)}else u.continue();else e()},u.onerror=t}))},Me.prototype.executeRegexLogic=function(e,t){var n,r=this,o=this.objectStore.index(e).openCursor();return this.shouldAddValue=function(e){return t.test(e.key)&&r.whereChecker.check(e.value)},f((function(e,t){o.onsuccess=function(o){if(n=o.target.result)if(r.shouldAddValue(n))try{var u=n.update(Be(r.query,n.value));u.onsuccess=function(){++r.rowAffected,n.continue()},u.onerror=t}catch(e){t(e)}else n.continue();else e()},o.onerror=t}))},Me.prototype.executeInLogic=function(e,t){var n=this,r=this.objectStore.index(e),o=this.query;return Q(t.map((function(e){return t=e,f((function(e,u){var i=r.openCursor(n.util.keyRange(t));i.onsuccess=function(t){var r=t.target.result;if(r){var i=r.value;if(n.whereChecker.check(i))try{var a=r.update(Be(o,i));a.onsuccess=function(){++n.rowAffected,r.continue()},a.onerror=u}catch(e){u(e)}else r.continue()}else e()},i.onerror=u}));var t})))};var Ke=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ge=function(){return Ge=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},Ge.apply(this,arguments)},Fe=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r}return Ke(t,e),t.prototype.execute=function(){var e,t,n=this,r=this.query,o=0,u={},i={},a=!0,s=r.queries,c=s.length;if(s.every((function(e,t){return!(t+1<c&&e.from!==s[t+1].from&&(a=!1,1))})),a){var l=this.primaryKey(s[0].from);e=function(e){return e[l]}}else e=function(e){var t="";for(var n in e)t+=e[n];return t};var f=function(){if(o<c)return(t=new Ne(s[o],n.util)).execute().then((function(t){return u={},t.forEach((function(t){var n=e(t);0===o?i[n]=t:null!=i[n]&&(u[n]=t)})),o>0&&(i=Ge({},u)),++o,f()}));var a,l=[],h=void 0,p=r.skip,y=r.limit,d=!1,v=function(){l.push(u[a])},m=function(){l.length<y?v():d=!0},b=function(e){0===p?e():--p};if(h=r.skip&&r.limit?function(){b((function(){m()}))}:r.limit?m:r.skip?function(){b((function(){v()}))}:function(){v()},y){for(a in u)if(h(a),d)break}else for(a in u)h(a);return t.results=l,Object.assign(t.query,{order:r.order,join:{}}),t.processOrderBy(),t.processGroupDistinctAggr(),t.results};return f()},t}(D),Ue=function(){function e(){}return e.prototype.execute=function(e){return f((function(t,n){var r=indexedDB.deleteDatabase(e);r.onblocked=function(){var e=new I(_);return n(L(e))},r.onerror=function(e){return n(L(e))},r.onsuccess=function(){t()}}))},e}(),Je=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),ze=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r}return Je(t,e),t.prototype.execute=function(){var e,t=this,n=this.query,r=0,o=new Map,u=!0,i=n.length;if(n.every((function(e,t){return!(t+1<i&&e.from!==n[t+1].from&&(u=!1,1))})),u){var a=this.primaryKey(n[0].from);e=function(e){return e[a]}}else e=function(e){var t="";for(var n in e)t+=e[n];return t};var s=function(){return r<n.length?new Ne(n[r++],t.util).execute().then((function(t){return t.forEach((function(t){o.set(e(t),t)})),s()})):Array.from(o.values())};return s()},t}(D),$e=function(e){var t=this;return function(n){var r=n.target.result;r?(t.shouldAddValue(r.value)&&(r.delete(),++t.rowAffected),r.continue()):e()}},He=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Xe=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r.tableName=t.from,r}return He(t,e),t.prototype.execute=function(e){var t,n=this,r=new M(this.db),u=this.query,i=r.validate(o.Remove,u);return i?N(i):e().then((function(e){try{n.initTransaction_(),t=null!=u.where?J(u.where)?n.processWhereArrayQry():n.processWhere_():n.executeWhereUndefinedLogic()}catch(e){return n.onException(e)}return t.then((function(){return n.rowAffected}))}))},t.prototype.processWhereArrayQry=function(){var e=this,t=new Ne(this.query,this.util);return t.isTxQuery=this.isTxQuery,t.execute().then((function(t){var n,r,o=[],u=e.primaryKey(e.query.from);t.forEach((function(e){o.push(e[u])})),t=null;var a=((n={})[u]=((r={})[i.In]=o,r),n);return e.query[i.Where]=a,e.processWhere_()}))},t.prototype.processWhere_=function(){var e=this;return this.shouldAddValue=function(t){return e.whereChecker.check(t)},this.query.where.or&&this.processOrLogic(),this.goToWhereLogic().then((function(){return e.onWhereEvaluated()}))},t.prototype.initTransaction_=function(){this.isTxQuery||this.util.createTransaction([this.query.from]),this.objectStore=this.util.objectStore(this.query.from)},t.prototype.onWhereEvaluated=function(){if(this.isOr)return this.orQuerySuccess_()},t.prototype.orQuerySuccess_=function(){var e=this,t=this._orInfo.OrQuery,n=H(t);if(null!=n){var r={};return r[n]=t[n],delete t[n],this.query.where=r,this.goToWhereLogic().then((function(){return e.onWhereEvaluated()}))}this.isOr=!0},t.prototype.processOrLogic=function(){this.isOr=!0;var e=this.query.where;this._orInfo={OrQuery:e.or},delete e.or},t}(Ee);Xe.prototype.executeInLogic=function(e,t){var n=this,r=this.objectStore.index(e);return Q(t.map((function(e){return t=e,f((function(e,o){var u=r.openCursor(n.util.keyRange(t));u.onsuccess=$e.call(n,e),u.onerror=o}));var t})))},Xe.prototype.executeWhereUndefinedLogic=function(){var e,t=this,n=this.objectStore.openCursor();return f((function(r,o){n.onsuccess=function(n){(e=n.target.result)?(e.delete(),++t.rowAffected,e.continue()):r()},n.onerror=o}))},Xe.prototype.executeWhereLogic=function(e,t,n){var r=this;t=n?t[n]:t;var o=this.objectStore.index(e).openCursor(this.util.keyRange(t,n));return f((function(e,t){o.onsuccess=$e.call(r,e),o.onerror=t}))},Xe.prototype.executeRegexLogic=function(e,t){var n,r=this,o=this.objectStore.index(e).openCursor();return this.shouldAddValue=function(e){return t.test(e.key)&&r.whereChecker.check(e.value)},f((function(e,t){o.onsuccess=function(t){(n=t.target.result)?(r.shouldAddValue(n)&&(n.delete(),++r.rowAffected),n.continue()):e()},o.onerror=t}))};var Ye=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ze=function(e){function t(t,n){var r=e.call(this)||this;return r.query=t,r.util=n,r.tableName=t,r}return Ye(t,e),t.prototype.execute=function(e){var t=this,n=this.query;return this.isTxQuery||this.util.createTransaction([n,j.tableName]),e().then((function(e){var r=t.util.objectStore(n).clear();try{return f((function(e,o){r.onsuccess=function(r){var u=t.table(n);for(var i in u.autoIncColumnValue)u.autoIncColumnValue[i]=0;j.set(j.dbSchema,t.util.db,t.util).then(e).catch(o)},r.onerror=o}))}catch(e){return t.onException(e)}}))},t}(D),et=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),tt=function(e){function t(t,n){var r=e.call(this)||this;return r.results={},r.reqQueue=[],r.isQueryExecuting=!1,r.isTxStarted_=!1,r.query=t,r.util=n,r}return et(t,e),t.prototype.execute=function(e){var t=this;this.beforeExecute=e;var n=this.validate();return n?N(n):(this.startExecution_(),f((function(e,n){t.onSuccess=e,t.onError=n})).then((function(e){return t.beforeExecute=null,t.log("transaction finished"),e})))},t.prototype.validate=function(){var e=this.query,t=this.notExistingTable_(e.tables);if(t)return new I(b,{tableName:t});var n=e.method;return We(n)?void 0:new I(S,n)},t.prototype.startExecution_=function(){var e=this,t=this.query,n=function(t){return function(n){return e.pushReq_({name:t,query:n})}},r=t.method,u=We(r);return this.log("transaction query started"),u.call(this,{data:t.data,insert:n(o.Insert),select:n(o.Select),update:n(o.Update),remove:n(o.Remove),count:n(o.Count),setResult:function(t,n){e.results[t]=n},getResult:function(t){return e.results[t]},abort:function(t){e.abortTx_(t)},start:function(){e.startTx_()}})},t.prototype.log=function(e){this.util.logger.log(e)},t.prototype.startTx_=function(){var e=this;try{this.isTxStarted_=!0;var t=this.query.tables;return t=t.concat(j.tableName),this.util.createTransaction(t).then((function(t){e.onSuccess(e.results)})).catch((function(t){e.onError(t)})),this.processExecutionOfQry_()}catch(e){this.onError(this.onException(e))}},t.prototype.onReqFinished_=function(e){var t=this.reqQueue.shift();this.log("finished request : ".concat(t.name," ")),t&&(e.error?(this.abortTx_("automatic abort of transaction due to error occured"),this.log("transaction aborted due to error occured"),this.onError(e.error)):(this.isQueryExecuting=!1,t.onSuccess&&t.onSuccess(e),this.processExecutionOfQry_()))},t.prototype.abortTx_=function(e){this.reqQueue=[],this.util.abortTransaction(),this.log("transaction aborted. Msg : ".concat(e))},t.prototype.executeRequest_=function(e){var t,n=this;this.isQueryExecuting=!0,this.log("executing request : ".concat(e.name," "));var r=this.onReqFinished_.bind(this),u=e.query,i=function(e){t=new e(u,n.util)};switch(e.name){case o.Select:i(Ne);break;case o.Insert:i(G);break;case o.Update:i(Me);break;case o.Remove:i(Xe);break;case o.Count:i(Ve)}t.isTxQuery=!0,t.execute(this.beforeExecute).then(r).catch((function(e){r({error:e})}))},t.prototype.pushReq_=function(e){var t=f((function(t,n){e.onSuccess=function(e){t(e)},e.onError=function(e){n(e)}}));return this.reqQueue.push(e),!0===this.isTxStarted_&&this.processExecutionOfQry_(),this.log("request pushed : ".concat(e.name)),t},t.prototype.processExecutionOfQry_=function(){!1===this.isQueryExecuting&&this.reqQueue.length>0&&this.executeRequest_(this.reqQueue[0])},t.prototype.notExistingTable_=function(e){var t=this,n=null;return e.every((function(e){return null!=t.table(e)||(n=e,!1)})),n},t}(D),nt=function(e){var t={name:e.name,version:e.version,tables:[]};return e.tables.forEach((function(e){var n={name:e.name,columns:{}};e.columns.forEach((function(e){n.columns[e.name]=e})),t.tables.push(n)})),t},rt=function(){function e(e){this.middlewares=[],this.util=new R,this.onQryFinished=F?function(e){self.postMessage(e)}:e}return Object.defineProperty(e.prototype,"db",{get:function(){return this.util.db},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"logger",{get:function(){return this.util.logger},enumerable:!1,configurable:!0}),e.prototype.executeMiddleware_=function(e){var t=this,n=$(this.middlewares)-1;if(n<0)return l();var r={},o=this.db;return Object.defineProperty(r,"database",{get:function(){return nt(o)}}),f((function(o){var u=0,i=function(){if(u<=n){var a=We(t.middlewares[u++])(e,r);a&&a.then||(a=Promise.resolve(a)),a.then((function(e){i()}))}else o()};i()}))},e.prototype.executeQuery=function(e,t){var n,r=e.query,u=this,i=u.util,a=function(e,t){n=new e(r,i).execute(t)};switch(e.name){case o.OpenDb:t(),n=u.openDb(r);break;case o.InitDb:t(),n=u.initDb(r);break;case o.CloseDb:t(),n=u.closeDb();break;case o.Insert:a(G,t);break;case o.Select:a(Ne,t);break;case o.Count:a(Ve,t);break;case o.Update:a(Me,t);break;case o.Intersect:t(),a(Fe);break;case o.DropDb:t(),n=u.dropDb();break;case o.Terminate:t(),n=u.terminate();break;case o.Union:t(),a(ze);break;case o.Remove:a(Xe,t);break;case o.Clear:a(Ze,t);break;case o.Transaction:a(tt,t);break;case o.Get:t(),n=j.get(r,i);break;case o.Set:t(),n=j.set(r.key,r.value,i);break;case o.ImportScripts:t(),n=u.importScripts_(e);break;case o.ChangeLogStatus:t(),u.logger.status=r,n=Promise.resolve();break;case o.Middleware:return t(),We(r)?(u.middlewares.push(r),l()):N(new I(E,r));default:n=l()}return u.logger.log("Executing query ".concat(e.name," in web worker")),n},e.prototype.callMiddleware_=function(e,t){return f((function(n){var r=0,o=$(e)-1,u=function(){if(r<=o){var i=e[r++](t);i instanceof Promise||(i=l(i)),i.then((function(e){t=e,u()}))}else n(t)};u()}))},e.prototype.run=function(e){var t=this,n=[],r=[];e.onResult=function(e){n.push((function(t){return e(t)}))},e.beforeExecute=function(e){r.push((function(t){return e(t)}))},this.executeMiddleware_(e).then((function(o){return t.executeQuery(e,(function(){return t.callMiddleware_(r)})).then((function(e){return t.callMiddleware_(n,e).then((function(e){t.returnResult_({result:e})}))}))})).catch((function(e){n=[];var r={error:L(e)};t.returnResult_(r)}))},e.prototype.importScripts_=function(e){return f((function(t,n){try{importScripts.apply(void 0,e.query),t()}catch(e){n(new I(T,e.message))}}))},e.prototype.returnResult_=function(e){this.logger.log("Query finished inside web worker"),this.util&&this.util.emptyTx(),this.onQryFinished(e)},e.prototype.dropDb=function(){var e=this.db.name;return this.terminate().then((function(){return(new Ue).execute(e)}))},e.prototype.closeDb=function(){return this.util.close()},e.prototype.terminate=function(){var e=this;return this.closeDb().then((function(){e.util.db=null}))},e.prototype.openDb=function(e){var t=this;return this.closeDb().then((function(n){return(t.db&&e.name===t.db.name?t.initDb():t.initDb({name:e.name,tables:[],version:e.version})).then((function(){return t.db}))}))},e.prototype.initDb=function(e){var t=this;if(!U)return N(new I(w));var n=e?new q(e):this.db;return this.util=new R,f((function(e,r){t.util.initDb(n).then((function(r){r.isCreated?j.get(j.dbSchema,t.util).then((function(o){o&&o.tables.forEach((function(e,t){var r=n.tables[t];r&&(r.autoIncColumnValue=e.autoIncColumnValue)})),t.util.db=n,r.database=nt(t.db),j.set(j.dbSchema,n,t.util).then((function(){e(r)}))})):j.get(j.dbSchema,t.util).then((function(n){t.util.db=n,r.database=nt(t.db),e(r)}))})).catch(r)}))},e}();if(F){var ot=new rt;self.onmessage=function(e){ot.run(e.data)}}JsStoreWorker=t})();
//# sourceMappingURL=jsstore.worker.min.js.map